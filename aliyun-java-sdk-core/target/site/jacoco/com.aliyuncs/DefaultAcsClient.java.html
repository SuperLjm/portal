<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultAcsClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">aliyun-java-sdk-core</a> &gt; <a href="index.source.html" class="el_package">com.aliyuncs</a> &gt; <span class="el_source">DefaultAcsClient.java</span></div><h1>DefaultAcsClient.java</h1><pre class="source lang-java linenums">package com.aliyuncs;

import com.aliyuncs.auth.*;
import com.aliyuncs.endpoint.DefaultEndpointResolver;
import com.aliyuncs.endpoint.EndpointResolver;
import com.aliyuncs.endpoint.ResolveEndpointRequest;
import com.aliyuncs.exceptions.ClientException;
import com.aliyuncs.exceptions.ErrorCodeConstant;
import com.aliyuncs.exceptions.ErrorMessageConstant;
import com.aliyuncs.exceptions.ServerException;
import com.aliyuncs.http.*;
import com.aliyuncs.profile.DefaultProfile;
import com.aliyuncs.profile.IClientProfile;
import com.aliyuncs.reader.Reader;
import com.aliyuncs.reader.ReaderFactory;
import com.aliyuncs.regions.ProductDomain;
import com.aliyuncs.transform.UnmarshallerContext;
import com.aliyuncs.unmarshaller.Unmarshaller;
import com.aliyuncs.unmarshaller.UnmarshallerFactory;
import com.aliyuncs.utils.IOUtils;
import com.aliyuncs.utils.LogUtils;
import org.slf4j.Logger;

import javax.xml.bind.annotation.XmlRootElement;
import java.io.IOException;
import java.net.SocketTimeoutException;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.util.concurrent.TimeUnit;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@SuppressWarnings(&quot;deprecation&quot;)
public class DefaultAcsClient implements IAcsClient {

    // Now maxRetryNumber and autoRetry has no effect.
<span class="fc" id="L37">    private int maxRetryNumber = 3;</span>
<span class="fc" id="L38">    private boolean autoRetry = true;</span>
<span class="fc" id="L39">    private IClientProfile clientProfile = null;</span>
    private AlibabaCloudCredentialsProvider credentialsProvider;
    private DefaultCredentialsProvider defaultCredentialsProvider;

    private IHttpClient httpClient;
    private EndpointResolver endpointResolver;
    private static final String SIGNATURE_BEGIN = &quot;string to sign is:&quot;;
<span class="fc" id="L46">    private final UserAgentConfig userAgentConfig = new UserAgentConfig();</span>

    /**
     * @Deprecated : Use DefaultAcsClient(String regionId) instead of this
     */
    @Deprecated
<span class="fc" id="L52">    public DefaultAcsClient() throws ClientException {</span>
<span class="fc" id="L53">        this.clientProfile = DefaultProfile.getProfile();</span>
<span class="fc" id="L54">        this.httpClient = HttpClientFactory.buildClient(this.clientProfile);</span>
<span class="fc" id="L55">    }</span>

<span class="fc" id="L57">    public DefaultAcsClient(String regionId) throws ClientException {</span>
<span class="fc" id="L58">        this.clientProfile = DefaultProfile.getProfile(regionId);</span>
<span class="fc" id="L59">        this.httpClient = HttpClientFactory.buildClient(this.clientProfile);</span>
<span class="fc" id="L60">        this.defaultCredentialsProvider = new DefaultCredentialsProvider();</span>
<span class="fc" id="L61">        this.endpointResolver = new DefaultEndpointResolver(this);</span>
<span class="fc" id="L62">        this.appendUserAgent(&quot;HTTPClient&quot;, this.httpClient.getClass().getSimpleName());</span>
<span class="fc" id="L63">    }</span>

    public DefaultAcsClient(IClientProfile profile) {
<span class="fc" id="L66">        this(profile, new StaticCredentialsProvider(profile));</span>
<span class="fc" id="L67">    }</span>

    public DefaultAcsClient(IClientProfile profile, AlibabaCloudCredentials credentials) {
<span class="fc" id="L70">        this(profile, new StaticCredentialsProvider(credentials));</span>
<span class="fc" id="L71">    }</span>

<span class="fc" id="L73">    public DefaultAcsClient(IClientProfile profile, AlibabaCloudCredentialsProvider credentialsProvider) {</span>
<span class="fc" id="L74">        this.clientProfile = profile;</span>
<span class="fc" id="L75">        this.credentialsProvider = credentialsProvider;</span>
<span class="fc" id="L76">        this.clientProfile.setCredentialsProvider(this.credentialsProvider);</span>
<span class="fc" id="L77">        this.httpClient = HttpClientFactory.buildClient(this.clientProfile);</span>
<span class="fc" id="L78">        this.endpointResolver = new DefaultEndpointResolver(this, profile);</span>
<span class="fc" id="L79">        this.appendUserAgent(&quot;HTTPClient&quot;, this.httpClient.getClass().getSimpleName());</span>
<span class="fc" id="L80">    }</span>

    @Override
    public &lt;T extends AcsResponse&gt; HttpResponse doAction(AcsRequest&lt;T&gt; request) throws ClientException,
            ServerException {
<span class="fc" id="L85">        return this.doAction(request, autoRetry, maxRetryNumber, this.clientProfile);</span>
    }

    @Override
    public &lt;T extends AcsResponse&gt; HttpResponse doAction(AcsRequest&lt;T&gt; request, boolean autoRetry, int maxRetryCounts)
            throws ClientException, ServerException {
<span class="fc" id="L91">        return this.doAction(request, autoRetry, maxRetryCounts, this.clientProfile);</span>
    }

    @Override
    public &lt;T extends AcsResponse&gt; HttpResponse doAction(AcsRequest&lt;T&gt; request, IClientProfile profile)
            throws ClientException, ServerException {
<span class="fc" id="L97">        return this.doAction(request, this.autoRetry, this.maxRetryNumber, profile);</span>
    }

    @Override
    public &lt;T extends AcsResponse&gt; HttpResponse doAction(AcsRequest&lt;T&gt; request, String regionId, Credential credential)
            throws ClientException, ServerException {
<span class="fc" id="L103">        Signer signer = Signer.getSigner(new LegacyCredentials(credential));</span>
<span class="fc" id="L104">        FormatType format = null;</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (null == request.getSysRegionId()) {</span>
<span class="fc" id="L106">            request.setSysRegionId(regionId);</span>
        }
<span class="fc" id="L108">        return doAction(request, autoRetry, maxRetryNumber, regionId, new LegacyCredentials(credential), signer,</span>
                format);
    }

    @Override
    public &lt;T extends AcsResponse&gt; T getAcsResponse(AcsRequest&lt;T&gt; request) throws ServerException, ClientException {
<span class="fc" id="L114">        HttpResponse baseResponse = this.doAction(request);</span>
<span class="fc" id="L115">        return parseAcsResponse(request, baseResponse);</span>
    }

    @Override
    public &lt;T extends AcsResponse&gt; T getAcsResponse(AcsRequest&lt;T&gt; request, boolean autoRetry, int maxRetryCounts)
            throws ServerException, ClientException {
<span class="fc" id="L121">        HttpResponse baseResponse = this.doAction(request, autoRetry, maxRetryCounts);</span>
<span class="fc" id="L122">        return parseAcsResponse(request, baseResponse);</span>
    }

    @Override
    public &lt;T extends AcsResponse&gt; T getAcsResponse(AcsRequest&lt;T&gt; request, IClientProfile profile)
            throws ServerException, ClientException {
<span class="fc" id="L128">        HttpResponse baseResponse = this.doAction(request, profile);</span>
<span class="fc" id="L129">        return parseAcsResponse(request, baseResponse);</span>
    }

    @Override
    public &lt;T extends AcsResponse&gt; T getAcsResponse(AcsRequest&lt;T&gt; request, String regionId, Credential credential)
            throws ServerException, ClientException {
<span class="fc" id="L135">        HttpResponse baseResponse = this.doAction(request, regionId, credential);</span>
<span class="fc" id="L136">        return parseAcsResponse(request, baseResponse);</span>
    }

    @Override
    public &lt;T extends AcsResponse&gt; T getAcsResponse(AcsRequest&lt;T&gt; request, String regionId) throws ServerException,
            ClientException {
<span class="fc bfc" id="L142" title="All 2 branches covered.">        if (null == request.getSysRegionId()) {</span>
<span class="fc" id="L143">            request.setSysRegionId(regionId);</span>
        }
<span class="fc" id="L145">        HttpResponse baseResponse = this.doAction(request);</span>
<span class="fc" id="L146">        return parseAcsResponse(request, baseResponse);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public CommonResponse getCommonResponse(CommonRequest request) throws ServerException, ClientException {
<span class="fc" id="L152">        HttpResponse baseResponse = this.doAction(request.buildRequest());</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (baseResponse.isSuccess()) {</span>
<span class="fc" id="L154">            String stringContent = baseResponse.getHttpContentString();</span>
<span class="fc" id="L155">            CommonResponse response = new CommonResponse();</span>
<span class="fc" id="L156">            response.setData(stringContent);</span>
<span class="fc" id="L157">            response.setHttpStatus(baseResponse.getStatus());</span>
<span class="fc" id="L158">            response.setHttpResponse(baseResponse);</span>
<span class="fc" id="L159">            return response;</span>
        } else {
<span class="fc" id="L161">            FormatType format = baseResponse.getHttpContentType();</span>
<span class="fc" id="L162">            AcsError error = readError(baseResponse, format);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">            if (500 &lt;= baseResponse.getStatus()) {</span>
<span class="fc" id="L164">                throw new ServerException(error.getErrorCode(), error.getErrorMessage(), error.getRequestId());</span>
            } else {
<span class="fc" id="L166">                throw new ClientException(error.getErrorCode(), error.getErrorMessage(), error.getRequestId());</span>
            }
        }
    }

    @Override
    public &lt;T extends AcsResponse&gt; HttpResponse doAction(AcsRequest&lt;T&gt; request, boolean autoRetry, int maxRetryCounts,
                                                         IClientProfile profile) throws ClientException, ServerException {
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (null == profile) {</span>
<span class="fc" id="L175">            throw new ClientException(&quot;SDK.InvalidProfile&quot;, &quot;No active profile found.&quot;);</span>
        }
<span class="fc" id="L177">        boolean retry = autoRetry;</span>
<span class="fc" id="L178">        int retryNumber = maxRetryCounts;</span>
<span class="fc" id="L179">        String region = profile.getRegionId();</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">        if (null == request.getSysRegionId()) {</span>
<span class="fc" id="L181">            request.setSysRegionId(region);</span>
        }
        AlibabaCloudCredentials credentials;
<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (null == credentialsProvider) {</span>
<span class="fc" id="L185">            credentials = this.defaultCredentialsProvider.getCredentials();</span>
        } else {
<span class="fc" id="L187">            credentials = this.credentialsProvider.getCredentials();</span>
        }
<span class="fc" id="L189">        Signer signer = Signer.getSigner(credentials);</span>
<span class="fc" id="L190">        FormatType format = profile.getFormat();</span>

<span class="fc" id="L192">        return this.doAction(request, retry, retryNumber, request.getSysRegionId(), credentials, signer, format);</span>
    }

    private &lt;T extends AcsResponse&gt; T parseAcsResponse(AcsRequest&lt;T&gt; request, HttpResponse baseResponse)
            throws ServerException, ClientException {
<span class="fc" id="L197">        FormatType format = baseResponse.getHttpContentType();</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (baseResponse.isSuccess()) {</span>
<span class="fc" id="L199">            return readResponse(request.getResponseClass(), baseResponse, format);</span>
        } else {
<span class="fc" id="L201">            AcsError error = readError(baseResponse, format);</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">            if (500 &lt;= baseResponse.getStatus()) {</span>
<span class="fc" id="L203">                throw new ServerException(error.getErrorCode(), error.getErrorMessage(), error.getRequestId());</span>
<span class="pc bpc" id="L204" title="1 of 4 branches missed.">            } else if (400 == baseResponse.getStatus() &amp;&amp; (&quot;IncompleteSignature&quot;.equals(error.getErrorCode())</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">                    || &quot;SignatureDoesNotMatch&quot;.equals(error.getErrorCode()))) {</span>
<span class="fc" id="L206">                String errorMessage = error.getErrorMessage();</span>
<span class="fc" id="L207">                Pattern startPattern = Pattern.compile(SIGNATURE_BEGIN);</span>
<span class="fc" id="L208">                Matcher startMatcher = startPattern.matcher(errorMessage);</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">                if (startMatcher.find()) {</span>
<span class="fc" id="L210">                    int start = startMatcher.end();</span>
<span class="fc" id="L211">                    String errorStrToSign = errorMessage.substring(start);</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">                    if (request.strToSign.equals(errorStrToSign)) {</span>
<span class="fc" id="L213">                        throw new ClientException(&quot;SDK.InvalidAccessKeySecret&quot;,</span>
<span class="fc" id="L214">                                &quot;Specified Access Key Secret is not valid.&quot;, error.getRequestId());</span>
                    }
                }
            }
<span class="fc" id="L218">            throw new ClientException(error.getErrorCode(), error.getErrorMessage(), error.getRequestId());</span>
        }
    }

    /**
     * @Deprecated : Use other overload methods
     */
    @Deprecated
    public &lt;T extends AcsResponse&gt; HttpResponse doAction(AcsRequest&lt;T&gt; request, boolean autoRetry, int maxRetryNumber,
                                                         String regionId, Credential credential, Signer signer, FormatType format) throws ClientException,
            ServerException {
<span class="nc" id="L229">        return doAction(request, autoRetry, maxRetryNumber, regionId, new LegacyCredentials(credential), signer,</span>
                format);
    }

    private &lt;T extends AcsResponse&gt; HttpResponse doAction(AcsRequest&lt;T&gt; request, boolean autoRetry, int maxRetryNumber,
                                                          String regionId, AlibabaCloudCredentials credentials, Signer signer, FormatType format)
            throws ClientException, ServerException {

<span class="fc" id="L237">        doActionWithProxy(request.getSysProtocol(),</span>
<span class="fc" id="L238">                System.getenv(&quot;HTTPS_PROXY&quot;), System.getenv(&quot;HTTP_PROXY&quot;));</span>
<span class="fc" id="L239">        doActionWithIgnoreSSL(request, X509TrustAll.ignoreSSLCerts);</span>

<span class="fc" id="L241">        Logger logger = clientProfile.getLogger();</span>
<span class="fc" id="L242">        String startTime = &quot;&quot;;</span>
<span class="fc" id="L243">        String timeCost = &quot;&quot;;</span>
<span class="fc" id="L244">        HttpResponse response = null;</span>
<span class="fc" id="L245">        String errorMessage = &quot;&quot;;</span>
        try {
<span class="fc" id="L247">            FormatType requestFormatType = request.getSysAcceptFormat();</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">            if (null != requestFormatType) {</span>
<span class="fc" id="L249">                format = requestFormatType;</span>
            }
<span class="fc" id="L251">            ProductDomain domain = null;</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">            if (request.getSysProductDomain() != null) {</span>
<span class="fc" id="L253">                domain = request.getSysProductDomain();</span>
            } else {
<span class="fc" id="L255">                ResolveEndpointRequest resolveEndpointRequest = new ResolveEndpointRequest(regionId, request</span>
<span class="fc" id="L256">                        .getSysProduct(), request.getSysLocationProduct(), request.getSysEndpointType());</span>
<span class="fc" id="L257">                resolveEndpointRequest.setProductEndpointMap(request.productEndpointMap);</span>
<span class="fc" id="L258">                resolveEndpointRequest.setProductEndpointRegional(request.productEndpointRegional);</span>
<span class="fc" id="L259">                resolveEndpointRequest.setProductNetwork(request.productNetwork);</span>
<span class="fc" id="L260">                resolveEndpointRequest.setProductSuffix(request.productSuffix);</span>
<span class="fc" id="L261">                String endpoint = endpointResolver.resolve(resolveEndpointRequest);</span>
<span class="fc" id="L262">                domain = new ProductDomain(request.getSysProduct(), endpoint);</span>

<span class="fc bfc" id="L264" title="All 2 branches covered.">                if (endpoint.endsWith(&quot;endpoint-test.exception.com&quot;)) {</span>
                    // For endpoint testability, if the endpoint is xxxx.endpoint-test.special.com
                    // throw a client exception with this endpoint
<span class="fc" id="L267">                    throw new ClientException(ErrorCodeConstant.SDK_ENDPOINT_TESTABILITY, endpoint);</span>
                }
            }
<span class="fc bfc" id="L270" title="All 2 branches covered.">            if (request.getSysProtocol() == null) {</span>
<span class="fc" id="L271">                request.setSysProtocol(this.clientProfile.getHttpClientConfig().getProtocolType());</span>
            }
<span class="fc" id="L273">            request.putHeaderParameter(&quot;User-Agent&quot;, UserAgentConfig.resolve(request.getSysUserAgentConfig(),</span>
                    this.userAgentConfig));
            try {

<span class="fc" id="L277">                HttpRequest httpRequest = request.signRequest(signer, credentials, format, domain);</span>
<span class="fc" id="L278">                HttpUtil.debugHttpRequest(request);</span>
<span class="fc" id="L279">                startTime = LogUtils.localeNow();</span>
<span class="fc" id="L280">                long start = System.nanoTime();</span>
<span class="fc" id="L281">                response = this.httpClient.syncInvoke(httpRequest);</span>
<span class="fc" id="L282">                long end = System.nanoTime();</span>
<span class="fc" id="L283">                timeCost = TimeUnit.NANOSECONDS.toMillis(end - start) + &quot;ms&quot;;</span>
<span class="fc" id="L284">                HttpUtil.debugHttpResponse(response);</span>
<span class="fc" id="L285">                return response;</span>
<span class="fc" id="L286">            } catch (SocketTimeoutException exp) {</span>
<span class="fc" id="L287">                errorMessage = exp.getMessage();</span>
<span class="fc" id="L288">                throw new ClientException(&quot;SDK.ServerUnreachable&quot;,</span>
                        &quot;SocketTimeoutException has occurred on a socket read or accept.The url is &quot; +
<span class="fc" id="L290">                                request.getSysUrl(), exp);</span>
<span class="fc" id="L291">            } catch (IOException exp) {</span>
<span class="fc" id="L292">                errorMessage = exp.getMessage();</span>
<span class="fc" id="L293">                throw new ClientException(&quot;SDK.ServerUnreachable&quot;,</span>
<span class="fc" id="L294">                        &quot;Server unreachable: connection &quot; + request.getSysUrl() + &quot; failed&quot;, exp);</span>
            }
<span class="fc" id="L296">        } catch (InvalidKeyException exp) {</span>
<span class="fc" id="L297">            errorMessage = exp.getMessage();</span>
<span class="fc" id="L298">            throw new ClientException(&quot;SDK.InvalidAccessSecret&quot;, &quot;Specified access secret is not valid.&quot;, exp);</span>
<span class="fc" id="L299">        } catch (NoSuchAlgorithmException exp) {</span>
<span class="fc" id="L300">            errorMessage = exp.getMessage();</span>
<span class="fc" id="L301">            throw new ClientException(&quot;SDK.InvalidMD5Algorithm&quot;, &quot;MD5 hash is not supported by client side.&quot;, exp);</span>
        } finally {
<span class="fc bfc" id="L303" title="All 2 branches covered.">            if (null != logger) {</span>
                try {
<span class="fc" id="L305">                    LogUtils.LogUnit logUnit = LogUtils.createLogUnit(request, response);</span>
<span class="fc" id="L306">                    logUnit.setStartTime(startTime);</span>
<span class="fc" id="L307">                    logUnit.setCost(timeCost);</span>
<span class="fc" id="L308">                    logUnit.setError(errorMessage);</span>
<span class="fc" id="L309">                    String logContent = LogUtils.fillContent(clientProfile.getLogFormat(), logUnit);</span>
<span class="fc" id="L310">                    logger.info(logContent);</span>
<span class="fc" id="L311">                } catch (Throwable e) {</span>
<span class="fc" id="L312">                    e.printStackTrace();</span>
<span class="fc" id="L313">                }</span>
            }
        }
    }

    /**
     * 2019-01-03 change access control from private to protected, then subClass can
     * override it and rewrite httpResponse processing
     */
    protected &lt;T extends AcsResponse&gt; T readResponse(Class&lt;T&gt; clasz, HttpResponse httpResponse, FormatType format)
            throws ClientException {
        // new version response contains &quot;@XmlRootElement&quot; annotation
<span class="fc bfc" id="L325" title="All 2 branches covered.">        if (clasz.isAnnotationPresent(XmlRootElement.class) &amp;&amp; !clientProfile.getHttpClientConfig()</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">                .isCompatibleMode()) {</span>
<span class="fc" id="L327">            Unmarshaller unmarshaller = UnmarshallerFactory.getUnmarshaller(format);</span>
<span class="fc" id="L328">            return unmarshaller.unmarshal(clasz, httpResponse.getHttpContentString());</span>
        } else {
<span class="fc" id="L330">            Reader reader = ReaderFactory.createInstance(format);</span>
<span class="fc" id="L331">            UnmarshallerContext context = new UnmarshallerContext();</span>
<span class="fc" id="L332">            T response = null;</span>
<span class="fc" id="L333">            String stringContent = httpResponse.getHttpContentString();</span>

<span class="fc bfc" id="L335" title="All 2 branches covered.">            if (stringContent == null) {</span>
<span class="fc" id="L336">                throw new ClientException(ErrorCodeConstant.SDK_INVALID_SERVER_RESPONSE,</span>
                        ErrorMessageConstant.SERVER_RESPONSE_HTTP_BODY_EMPTY);
            }

            try {
<span class="fc" id="L341">                response = clasz.newInstance();</span>
<span class="fc" id="L342">            } catch (Exception e) {</span>
<span class="fc" id="L343">                throw new ClientException(&quot;SDK.InvalidResponseClass&quot;, &quot;Unable to allocate &quot; + clasz.getName()</span>
                        + &quot; class&quot;);
<span class="fc" id="L345">            }</span>

<span class="fc" id="L347">            String responseEndpoint = clasz.getName().substring(clasz.getName().lastIndexOf(&quot;.&quot;) + 1);</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">            if (response.checkShowJsonItemName()) {</span>
<span class="fc" id="L349">                context.setResponseMap(reader.read(stringContent, responseEndpoint));</span>
            } else {
<span class="fc" id="L351">                context.setResponseMap(reader.readForHideArrayItem(stringContent, responseEndpoint));</span>
            }

<span class="fc" id="L354">            context.setHttpResponse(httpResponse);</span>
<span class="fc" id="L355">            response.getInstance(context);</span>
<span class="fc" id="L356">            return response;</span>
        }
    }

    private AcsError readError(HttpResponse httpResponse, FormatType format) throws ClientException {
<span class="fc" id="L361">        AcsError error = new AcsError();</span>
<span class="fc" id="L362">        String responseEndpoint = &quot;Error&quot;;</span>
<span class="fc" id="L363">        Reader reader = ReaderFactory.createInstance(format);</span>
<span class="fc" id="L364">        UnmarshallerContext context = new UnmarshallerContext();</span>
<span class="fc" id="L365">        String stringContent = httpResponse.getHttpContentString();</span>

<span class="fc bfc" id="L367" title="All 2 branches covered.">        if (stringContent == null) {</span>
<span class="fc" id="L368">            error.setErrorCode(&quot;(null)&quot;);</span>
<span class="fc" id="L369">            error.setErrorMessage(&quot;(null)&quot;);</span>
<span class="fc" id="L370">            error.setRequestId(&quot;(null)&quot;);</span>
<span class="fc" id="L371">            error.setStatusCode(httpResponse.getStatus());</span>
<span class="fc" id="L372">            return error;</span>
        } else {
<span class="fc" id="L374">            context.setResponseMap(reader.read(stringContent, responseEndpoint));</span>
<span class="fc" id="L375">            return error.getInstance(context);</span>
        }
    }

    /**
     * Compatible with previous versions of proxy Settings
     */
    public void doActionWithProxy(ProtocolType protocolType, String httpsProxy, String httpProxy) {
<span class="fc" id="L383">        HttpClientConfig config = this.clientProfile.getHttpClientConfig();</span>
<span class="fc bfc" id="L384" title="All 4 branches covered.">        if (protocolType == ProtocolType.HTTP &amp;&amp; httpProxy != null) {</span>
<span class="fc" id="L385">            config.setHttpProxy(httpProxy);</span>
<span class="fc" id="L386">            return;</span>
        }
<span class="fc bfc" id="L388" title="All 4 branches covered.">        if (protocolType == ProtocolType.HTTPS &amp;&amp; httpsProxy != null) {</span>
<span class="fc" id="L389">            config.setHttpsProxy(httpsProxy);</span>
<span class="fc" id="L390">            return;</span>
        }
<span class="fc" id="L392">    }</span>

    /**
     * Compatible with previous versions of SSL Settings
     */
    public void doActionWithIgnoreSSL(AcsRequest request, boolean isIgnore) {
<span class="fc bfc" id="L398" title="All 2 branches covered.">        if (isIgnore) {</span>
<span class="fc" id="L399">            request.setIgnoreSSLCerts(true);</span>
        }
<span class="fc" id="L401">    }</span>


    @Deprecated
    public boolean isAutoRetry() {
<span class="fc" id="L406">        return autoRetry;</span>
    }

    @Deprecated
    public void setAutoRetry(boolean autoRetry) {
<span class="fc" id="L411">        this.autoRetry = autoRetry;</span>
<span class="fc" id="L412">    }</span>

    @Deprecated
    public int getMaxRetryNumber() {
<span class="fc" id="L416">        return maxRetryNumber;</span>
    }

    @Deprecated
    public void setMaxRetryNumber(int maxRetryNumber) {
<span class="fc" id="L421">        this.maxRetryNumber = maxRetryNumber;</span>
<span class="fc" id="L422">    }</span>

    @Override
    public void restoreSSLCertificate() {
<span class="fc" id="L426">        this.httpClient.restoreSSLCertificate();</span>
<span class="fc" id="L427">    }</span>

    @Override
    public void ignoreSSLCertificate() {
<span class="fc" id="L431">        this.httpClient.ignoreSSLCertificate();</span>
<span class="fc" id="L432">    }</span>

    public void setEndpointResolver(EndpointResolver resolver) {
<span class="fc" id="L435">        endpointResolver = resolver;</span>
<span class="fc" id="L436">    }</span>

    @Override
    public void shutdown() {
<span class="fc bfc" id="L440" title="All 2 branches covered.">        if (!this.httpClient.isSingleton()) {</span>
<span class="fc" id="L441">            IOUtils.closeQuietly(this.httpClient);</span>
<span class="fc" id="L442">            this.httpClient = null;</span>
        }

<span class="fc" id="L445">    }</span>

    public DefaultProfile getProfile() {
<span class="fc" id="L448">        return (DefaultProfile) clientProfile;</span>
    }

    public void appendUserAgent(String key, String value) {
<span class="fc" id="L452">        this.userAgentConfig.append(key, value);</span>
<span class="fc" id="L453">    }</span>

    public UserAgentConfig getUserAgentConfig() {
<span class="fc" id="L456">        return userAgentConfig;</span>
    }

    public IHttpClient getHttpClient() {
<span class="fc" id="L460">        return httpClient;</span>
    }

    public void setHttpClient(IHttpClient httpClient) {
<span class="fc" id="L464">        this.httpClient = httpClient;</span>
<span class="fc" id="L465">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>